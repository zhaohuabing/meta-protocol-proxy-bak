stats_server_version_override: 1
admin:
  access_log_path: ./trpc_debug.log
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 8080
static_resources:
  listeners:
    name: listener_0
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 28000
    filter_chains:
    - filters:
      - name: envoy.trpc_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.config.filter.network.trpc_proxy.v3.TrpcProxy
          stat_prefix: ingress_trpc
          route_config:
            name: testrouter
            virtual_hosts:
            - name: local_service
              domains: ["trpc.test.helloworld.Greeter"]
              routes:
              - match:
                  prefix: "/trpc.test.helloworld.Greeter/"
                route:
                  cluster: trpc.test.helloworld
                  #hash_policy:
                  #- connection_properties:
                  #    source_ip: true
                  #- header:
                  #    header_name: "test"
#          access_log:
#            - name: envoy.access_loggers.file
#              typed_config:
#                "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
#                path: "/dev/stdout"
#                log_format:
#                  text_format: "[%START_TIME%] %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %UPSTREAM_HOST%\n"

  clusters:
    name: trpc.test.helloworld
    type: STATIC
    connect_timeout: 0.25s
    lb_policy: ROUND_ROBIN
    #lb_policy: RING_HASH
    load_assignment:
      cluster_name: trpc.test.helloworld
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8000
      - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: 127.0.0.1
                  port_value: 8000
#                  port_value: 8001
    health_checks:
      - timeout: 1s
        interval: 1s
        no_traffic_interval: 5s
        interval_jitter: 1s
        unhealthy_threshold: 3
        healthy_threshold: 3
        custom_health_check:
          name: envoy.health_checkers.trpc
          typed_config:
            "@type": type.googleapis.com/envoy.config.health_checker.trpc_proxy.v3.Trpc
            only_verify_connect: true
            callee: trpc.test.helloworld.envoy
            caller: trpc.test.helloworld.Greeter
